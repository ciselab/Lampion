version: '3.8'

# This is an autogenerated file using a jinja2 template
# THIS IS NOT INTENDED TO BE CHANGED MANUALLY
# Recreate this using a different config

services:
  {% for config in configurations -%}
  CodeBert_CodeToText_Experiment_{{ config.run_number }}:
    image: ciselab/codebert-code2text:latest
    user: "${UID}"
    volumes:
      - ./{{ config.path_to }}/dataset/:/dataset:ro
      - ./{{ config.path_to }}/ur_dataset/:/ur_dataset:ro
      - ./{{ config.path_to }}/experiment_output:/experiment/output
    environment:
      test_file: /dataset/preprocessed_test_java.jsonl
      train_file: /ur_dataset/train_java.jsonl
      dev_file: /ur_dataset/valid_java.jsonl
      DO_TRAIN: "true"
      DO_VALID: "true"
      DO_TEST: "true
      lang: {{ config.lang | default("java",true)}}"
      batch_size: {{batch_size|default(8,true)}}
    {% if config.gpu_use %}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    {% else %}
    oom_kill_disable: true
    mem_limit: {{mem_limit|default("16g",true)}}
    memswap_limit: {{mem_limit|default("16g",true)}}
    {% endif %}
  {% endfor %}